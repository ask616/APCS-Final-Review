<!DOCTYPE html>
<html>
<head>
	<title>APCS Final Review</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
	
	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
	<link type="text/css" rel="stylesheet" href="materialize/css/materialize.min.css"  media="screen"/>
	<link rel="stylesheet" href="styles.css">
</head>
<body>

	<ul id='lessonDropdown' class='dropdown-content' id="dropdown-content">

		<li class="link-lesson" id="link-lesson-1"><a href="#">1 to 2</a></li>
		<li class="link-lesson" id="link-lesson-2"><a href="#">3</a></li>
		<li class="link-lesson" id="link-lesson-3"><a href="#">4 to 5</a></li>
		<li class="link-lesson" id="link-lesson-4"><a href="#">6</a></li>
		<li class="link-lesson" id="link-lesson-5"><a href="#">Binary</a></li>
		<li class="link-lesson" id="link-lesson-6"><a href="#">7</a></li>
		<li class="link-lesson" id="link-lesson-7"><a href="#">8</a></li>
		<li class="link-lesson" id="link-lesson-8"><a href="#">9</a></li>
		<li class="link-lesson" id="link-lesson-9"><a href="#">10</a></li>
		<li class="link-lesson" id="link-lesson-10"><a href="#">11</a></li>
		<li class="link-lesson" id="link-lesson-11"><a href="#">12</a></li>
		<li class="link-lesson" id="link-lesson-12"><a href="#">13 to 14</a></li>
		<li class="link-lesson" id="link-lesson-13"><a href="#">15</a></li>
		<li class="link-lesson" id="link-lesson-14"><a href="#">16</a></li>
		<li class="link-lesson" id="link-lesson-15"><a href="#">test</a></li>


	</ul>
	<nav class="blue darken-2" style="position:fixed">
		<div class="nav-wrapper">
			<div class="col s12">
				<a href="/" id="page-title" class="brand-logo" style="margin-left:30px;text-decoration:none">APCS Final Review</a>
				<ul class="right side-nav" style="margin-left:30px">
				<li><a href="/submit">Submit Problem</a></li>
					<li style="margin-right:40px"><a class="dropdown-button" href="#" data-activates='lessonDropdown'><span style="position:relative; top:-8px;left:-3px">Lesson <span id="lessonNum">1-2</span></span><i class="mdi-navigation-arrow-drop-down right"></i></a></li>
					
				</ul>
			</div>
		</div>
	</nav>
	<div class="row">
		<div class="col l2 sidebar" id="scrollbar">
			<div style="margin-top:80px" class="panels">

			</div>
		</div>

		<div class="col s9 content" id="scrollbar">
			<div class="container content-container" style="width:90%;">
				<section class="problem-section"></section>
					<div id="tooMany">
						If you're seeing this, the maximum number of connections have been made to the database. Please refresh the page in a few minutes and try again
					</div>
				<div class="footer"></div>
			</div>
		</div>
	</div>

	<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
	<script type="text/javascript" src="materialize/js/materialize.min.js"></script>
	<script type="text/javascript" src="https://code.jquery.com/ui/1.10.4/jquery-ui.min.js"></script>
	<script src="https://cdn.firebase.com/js/client/2.0.6/firebase.js"></script>

	<script type="text/javascript">
		var newContent;
		var ref = new Firebase("https://apcsfinalreview.firebaseio.com/");
		function initSetSetup(){
			
			var panels_content = "";
				var counter = 1;

				ref.child("1-2").once("value", function(snapshot) {
					snapshot.forEach(function(childSnapshot){
				  		panels_content+= '<div class="card-panel grey waves-effect waves-light text-center darken-3 set-panel" id="set-'+counter+'" style="margin-left:5px"><span class="white-text" style="font-size:24px;" id="set-title">Set '+counter+'</span></div>';
				  		if(counter >= snapshot.numChildren()){
							$(".panels").html(panels_content);
						}
						$(".set-panel").click(function(){
							set = parseInt($(this).attr('id').replace(/set-/,""));

							reload("1-2",set);
						});
						counter++;
					});
				});
		}


		function reload(lesson,set){
			var newRef = ref.child(lesson).child(set);
			newRef.once("value",function(basedSnapshot){
				newContent = '<div style="margin-top:50px;padding-bottom:30px;"><h2 class="header-text" style="padding-bottom:30px;padding-top:30px;display:inline">Set ' + set+ ' </h2><h5 style="display:inline;color:#bdbdbd">by '+basedSnapshot.child("name").val() + '</h5></div>';



				newRef.child('problems').once("value", function(snapshot) {
				  var counter = 1;
				  var loopCount = 1;
				  
				  snapshot.forEach(function(childSnapshot){
				  	var build = '<div class=problem><div class=title><h5 class="header-text subheader">Problem ' + counter + '</h5></div><br><br><br><pre class=problem-text style="background:none;border:none">'+childSnapshot.child(0).val()+'</pre><br><br><a class="waves-effect waves-light btn answer-show" id="answer-'+counter+'" style=text-decoration:none>Show Answer</a><br><pre id="pre-'+counter+'" style=display:none;font-size:12px>'+childSnapshot.child(1).val()+'</pre></div>';

				  	if(childSnapshot.child(0).val().length > 0 && childSnapshot.child(1).val().length >0)
				  		newContent = newContent + build;

					counter++;

					if(loopCount >= snapshot.numChildren()){
						newContent+='<br><div class="row"><a class="col s3 waves-effect waves-light btn edit-problem-button red darken-2" style=text-decoration:none>Edit Problems</a></br><div class="input-field edit_wrap col s4" style="top:-30px; display:none"><input id="edit_code" type="text" placeholder = "Enter code, then press the button again" required></div></div>';
						$(".problem-section").html(newContent);

						$(".answer-show").click(function() {
							var counter = $(this).attr('id').replace(/answer-/,"");
					        $('#pre-'+counter).slideToggle("fast");
					        console.log('#pre-'+counter);
					    });

					    $(".edit-problem-button").click(function() {
					    	if($("#edit_code").val().length > 0){
					    		if($("#edit_code").val() == basedSnapshot.child("code").val())
					    			reloadForEdit(lesson,set);
					    		else
					    			toast("Incorrect code!",3000);
					    	}
					    	else
								$('.edit_wrap').toggle("slide",  {direction: "left"}, 300);
					    });

						return true;
					}

					loopCount++;
				  })
				}, function (errorObject) {
				  console.log("The read failed: " + errorObject.code);
				});

			});
		}

		function parse(origString){
			var newLinesRemoved = origString.replace(/\n/g, "&#10;");
			var tabsReplaced = newLinesRemoved.replace(/\x20{4}/g,"&#9;").replace(/\t/g,"&#9;");
			
			for(var i=0;i<tabsReplaced.length;i++){
			    if(tabsReplaced.charAt(i)=='<' && tabsReplaced.charAt(i+1)!=" "){
			        if(tabsReplaced.substring(i+1,i+4)!="img" && tabsReplaced.substring(i+1,i+5)!="/img"){
			            tabsReplaced=  tabsReplaced.substr(0, i) + "&lt;" + tabsReplaced.substr(i + 1);
			        }
			    }
			}

			for(var i=1;i<tabsReplaced.length;i++){
			    if(tabsReplaced.charAt(i)=='>' && tabsReplaced.charAt(i-1)!=" "){
			        if(tabsReplaced.charAt(i-1) !="/"){
			            tabsReplaced= tabsReplaced.substr(0, i) + "&gt;" +  tabsReplaced.substr(i + 1);
			        }
			    }
			}

			return tabsReplaced;
		}

		function imageParse(origString){
			var openImageReplaced= origString.replace(/<img>/g,"<img width=\"400px\" src=\"")
			var closeImageReplaced = openImageReplaced.replace(/<\/img>/g,"\" />");


			for(var i=0;i<closeImageReplaced.length;i++){
			    if(closeImageReplaced.charAt(i)=='<' && closeImageReplaced.charAt(i+1)!=" "){
			        if(closeImageReplaced.substring(i+1,i+4)!="img" && closeImageReplaced.substring(i+1,i+5)!="/img"){
			            closeImageReplaced=  closeImageReplaced.substr(0, i) + "&lt;" + closeImageReplaced.substr(i + 1);
			        }
			    }
			}

			for(var i=1;i<closeImageReplaced.length;i++){
			    if(closeImageReplaced.charAt(i)=='>' && closeImageReplaced.charAt(i-1)!=" "){
			        if(closeImageReplaced.charAt(i-1) !="/"){
			            closeImageReplaced= closeImageReplaced.substr(0, i) + "&gt;" +  closeImageReplaced.substr(i + 1);
			        }
			    }
			}

			return closeImageReplaced;
		}

		function reloadForEdit(lesson,set){
			var newRef = ref.child(lesson).child(set);
			newRef.once("value",function(basedSnapshot){
				newContent = '<div style="margin-top:50px;padding-bottom:30px;"><h2 class="header-text" style="padding-bottom:30px;padding-top:30px;display:inline">Set ' + set+ ' </h2><h5 style="display:inline;color:#bdbdbd">by '+basedSnapshot.child("name").val() + '</h5></div>';

				newRef.child('problems').once("value", function(snapshot) {
				  var counter = 1;
				  var loopCount = 1;
				  
				  snapshot.forEach(function(childSnapshot){
				  	var build = '<div class=problem><div class=title><h5 class="header-text subheader">Problem ' + counter + '</h5></div><br><br><br><textarea id="problem-' + counter +'">'+childSnapshot.child(0).val()+'</textarea><br><br><a class="waves-effect waves-light btn answer-show" id="answer-'+counter+'" style=text-decoration:none>Edit Answer</a><br><textarea id="pre-'+counter+'" style=display:none;font-size:12px>'+childSnapshot.child(1).val()+'</textarea></div>';

				  	if(childSnapshot.child(0).val().length > 0 && childSnapshot.child(1).val().length >0)
				  		newContent = newContent + build;

					counter++;

					if(loopCount >= snapshot.numChildren()){
						var footerContent = '<br><div class="row"><a class="col s3 waves-effect waves-light btn edit-problem-button red darken-2" style=text-decoration:none>Save Changes</a><button class="btn waves-effect waves-light form-button pull-right problem-add" type="submit" name="action"; style="text-decoration:none">Add Problem<i class="mdi-content-add right"></i></button></div>';
						$(".problem-section").html(newContent);
						$(".footer").html(footerContent);
						$(".answer-show").click(function() {
							var counter = $(this).attr('id').replace(/answer-/,"");
					        $('#pre-'+counter).slideToggle("fast");
					        console.log('#pre-'+counter);
					    });

					    $(".edit-problem-button").click(function() {
					    	toast("Saving...");

							ref.child(lesson).once("value",function(snapshot){

								var name = basedSnapshot.child("name").val();

								var problems = [];
								for(var i=0;i<counter-1;i++){
									console.log(counter);
									var tuple = [imageParse($("#problem-"+(i+1)).val()),parse($("#pre-"+(i+1)).val())];
									console.log(tuple);
									problems.push(tuple);
								}
								var code = basedSnapshot.child("code").val();
								ref.child(lesson).child(set).set({
								    name: name,
								    problems:problems,
								    code:code
								},function(){
									var url = "/";
									$(location).attr('href',url);
								});
							});

					    });

					    $(".problem-add").click(function(){

					    	$('.problem-section').append('<div class=problem-submission><div class=row><h5>Problem '+(counter)+'</h5><br><div class="input-field col s12"><textarea id=problem-'+(counter)+'></textarea><label>Write your problem here <a class="problem-modal-trigger modal-trigger" href="#problem-modal">(?)</a>:</label></div></div><div class=row><div class="input-field col s12"><textarea id=pre-'+(counter)+'></textarea><label>Enter your solution here (Enter tabs as 4 spaces) <a class="solution-modal-trigger modal-trigger" href="#solution-modal">(?)</a>:</label></div></div></div>');
					    	counter++;
					    });

					}

					loopCount++;
				  })
				}, function (errorObject) {
				  console.log("The read failed: " + errorObject.code);
				});

			});
		}

		$(document).ready(function(){
			reload("1-2",1);
			initSetSetup();
			var lesson = 1;
			var set = 1;
			$(".link-lesson").click(function(){
				lesson = parseInt($(this).attr('id').replace(/link-lesson-/,""));
				console.log(lesson);
				var numInWords = ["1-2","3","4-5","6","Binary","7","8","9","10","11","12","13-14","15","16","test"];
				$("#lessonNum").html(numInWords[lesson-1]);
				reload(numInWords[lesson-1],1);
				var panels_content = "";
				var counter = 1;

				ref.child(""+numInWords[lesson-1]).once("value", function(snapshot) {
					console.log(snapshot.numChildren());
					if(snapshot.numChildren()==0)
						toast('No problems for this lesson yet', 3000);
					snapshot.forEach(function(childSnapshot){
				  		panels_content+= '<div class="card-panel grey waves-effect waves-light text-center darken-3 set-panel" id="set-'+counter+'" style="margin-left:5px"><span class="white-text" style="font-size:24px;" id="set-title">Set '+counter+'</span></div>';
				  		if(counter >= snapshot.numChildren()){
							$(".panels").html(panels_content);
						}
						$(".set-panel").click(function(){
							set = parseInt($(this).attr('id').replace(/set-/,""));
							console.log("hello");
							reload(numInWords[lesson-1],set);
						});

						counter++;
					});
				});

			});

			$('.dropdown-button').dropdown();

		});
	</script> 
</body>
</html>