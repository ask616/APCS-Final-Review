<!DOCTYPE html>
<html>
<head>
	<title>Problem Submission</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
	
	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
	<link type="text/css" rel="stylesheet" href="materialize/css/materialize.min.css"  media="screen"/>
	<link rel="stylesheet" href="submit_styles.css">
</head>
<body id="scrollbar">

	<nav class="blue darken-2">
		<div class="nav-wrapper">
			<div class="col s12">
				<a href="#" id="page-title" class="brand-logo" style="margin-left:30px;text-decoration:none">APCS Final Review - Problem Submission Form</a>
				<ul class="right side-nav" style="margin-left:30px">
					<li style="margin-right:40px;"><a href="/">Return</a></li>
				</ul>
			</div>
		</div>
	</nav>

	<div class="container" id="scrollbar">

		<!-- problem set number, problems, name, lesson num -->

		<b>Directions: </b>Fill out the following information and click <b>Submit</b> to add your problems. If you want to submit multiple problems for the same set, click <b>Add Problem</b>.

		<div class="row form">
			<form class="col s12">
				<div class="row">
					<div class="input-field col s6">
						<input id="first_name" type="text" required>
						<label for="first_name">First Name</label>
					</div>
					<div class="input-field col s6">
						<input id="last_name" type="text" required>
						<label for="last_name">Last Name</label>
					</div>
				</div>
				<div class="row">
					<div class="input-field col s12">
						<select id="lesson_select">
							<option value="" disabled selected>Choose your lesson</option>
							<option value="1-2"><a href="#">1 to 2</a></option>
							<option value="3"><a href="#">3</a></option>
							<option value="4-5"><a href="#">4 to 5</a></option>
							<option value="6"><a href="#">6</a></option>
							<option value="Binary"><a href="#">Binary</a></option>
							<option value="7"><a href="#">7</a></option>
							<option value="8"><a href="#">8</a></option>
							<option value="9"><a href="#">9</a></option>
							<option value="10"><a href="#">10</a></option>
							<option value="11"><a href="#">11</a></option>
							<option value="12"><a href="#">12</a></option>
							<option value="13-14"><a href="#">13 to 14</a></option>
							<option value="15"><a href="#">15</a></option>
							<option value='16'><a href="#">16</a></option>
							<option value='test'><a href="#">test</a></option>
						</select>
					</div>
				</div>

				<div class="problems">
					<div class="problem-submission">
						<div class="row">
							<h5>Problem 1</h5>
							<br>
							<div class="input-field col s12">
								<textarea id="problem-input1"></textarea>                
								<label>Write your problem here <a class="problem-modal-trigger modal-trigger" href="#problem-modal">(?)</a>:</label>
							</div>
						</div>
						<div class="row">
							<div class="input-field col s12">
								<textarea id="solution-input1"></textarea>
								<label>Enter your solution here (Enter tabs as 4 spaces) <a class="solution-modal-trigger modal-trigger" href="#solution-modal">(?)</a>:</label>
							</div>
						</div>
					</div>
				</div>


			</form>
		</div>

		<div class="form-buttons">

			<a class="waves-effect waves-light btn modal-trigger submit-button submit-modal-trigger" style="color:white" href="#submitted-modal">Submit<i class="mdi-content-send right"></i></a>
			<button class="btn waves-effect waves-light form-button pull-right problem-add" type="submit" name="action">Add Problem
				<i class="mdi-content-add right"></i>
			</button>
		</div>
	</div>


	<div id="problem-modal" class="modal" style="max-height:350px;">
		<h4>Adding Problems</h4>
		<p>Simply type in your problems into the textboxes below-keep in mind that how you format them here will be exactly how they'll show up on the viewing page. To add an image, just type in the <b>direct link to the image</b> surrounded by "img" tags as follows:</p>
		<pre style="display:inline-block">&lt;img&gt;http://i.imgur.com/uEVSYHY.png&lt;/img&gt;</pre>
		<br>
		<p>While adding code, try to stick with using either 4 spaces in a row or pasting in tabs (you'll see that you can't press the tab key while filling out this form), and the indentation should be preserved.</p>
		<br>
		<a href="#" class="waves-effect btn modal_close green accent-4">got it</a>
	</div>

	<div id="solution-modal" class="modal" style="max-height:270px;">
		<h4>Adding Solutions</h4>
		<p>Basically repeat you did above, but you won't be able to paste in images for this section. Again, if you're pasting code, stick to either 4 spaces or pasting tabs, as these are the only ways that are being covered for indentation.</p>
		<p>After submitting, you'll be given a 4-character alphanumeric password that you'll need to later be able to edit submissions</p>
		<br>
		<a href="#" class="waves-effect btn modal_close green accent-4">got it</a>
	</div>

	<div id="submitted-modal" class="modal" style="max-height:300px">
		<h4>Problem(s) Submitted</h4>
	    <p>Your work has been submitted. If you want to edit it later on, you'll need the code below to do so, so store it somewhere safe. Once the database has been updated, the button will be displayed in color.</p>
	    <br>
	    <h5 id="code" style="text-align:center"></h5>
	    <br>
	    <a href="#" class="waves-effect btn modal_close disabled" id="continue-button">Continue</a>
	</div>

	<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
	<script type="text/javascript" src="materialize/js/materialize.min.js"></script>
	<script type="text/javascript" src="https://code.jquery.com/ui/1.10.4/jquery-ui.min.js"></script>
	<script src="https://cdn.firebase.com/js/client/2.0.6/firebase.js"></script>
	<script type="text/javascript">
		var ref = new Firebase("https://apcsfinalreview.firebaseio.com/");
		$(document).ready(function(){
			$('.problem-modal-trigger,.solution-modal-trigger').leanModal();
			$('.submit-modal-trigger').leanModal();

			var counter = 1;

			$(".problem-add").click(function(){
				
				$('.problems').append('<div class=problem-submission><div class=row><h5>Problem '+(counter+1)+'</h5><br><div class="input-field col s12"><textarea id=problem-input'+(counter+1)+'></textarea><label>Write your problem here <a class="problem-modal-trigger modal-trigger" href="#problem-modal">(?)</a>:</label></div></div><div class=row><div class="input-field col s12"><textarea id=solution-input'+(counter+1)+'></textarea><label>Enter your solution here (Enter tabs as 4 spaces) <a class="solution-modal-trigger modal-trigger" href="#solution-modal">(?)</a>:</label></div></div></div>');
				counter++;
				$('.problem-modal-trigger,.solution-modal-trigger').leanModal();
			});
			$(".submit-button").click(function(){
				var code = "";
				var chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';

				for (var j = 0; j<4; j++)
					code += chars[Math.round(Math.random() * (chars.length - 1))];

				var lesson = $("#lesson_select").val().trim();
				var set;

				$("#code").html(code);
				ref.child(lesson).once("value",function(snapshot){
					set = snapshot.numChildren()+1;
					var name = $("#first_name").val().trim() + " " +$("#last_name").val().trim();
					var problems = [];
					for(var i=0;i<counter;i++){
						//[problem,solution]
						var tuple = [imageParse($("#problem-input"+(i+1)).val()),parse($("#solution-input"+(i+1)).val())];
						problems.push(tuple);
					}

					ref.child(lesson).child(set).set({
					    name: name,
					    problems:problems,
					    code:code
					},function(){
						$("#continue-button").removeClass("disabled");
					});
				});
				

			});

			$("#continue-button").click(function(){
				toast('Redirecting...', 3000);
			    	setTimeout(function(){
			    		var url = "/";
						$(location).attr('href',url);
					}, 3000);
			    });

		});

		function parse(origString){
			var newLinesRemoved = origString.replace(/\n/g, "&#10;");
			var tabsReplaced = newLinesRemoved.replace(/ {4}/g,"&#9;").replace(/\t/g,"&#9;");
			
			for(var i=0;i<tabsReplaced.length;i++){
			    if(tabsReplaced.charAt(i)=='<' && tabsReplaced.charAt(i+1)!=" "){
			        if(tabsReplaced.substring(i+1,i+4)!="img" && tabsReplaced.substring(i+1,i+5)!="/img"){
			            tabsReplaced=  tabsReplaced.substr(0, i) + "&lt;" + tabsReplaced.substr(i + 1);
			        }
			    }
			}

			for(var i=1;i<tabsReplaced.length;i++){
			    if(tabsReplaced.charAt(i)=='>' && tabsReplaced.charAt(i-1)!=" "){
			        if(tabsReplaced.charAt(i-1) !="/"){
			            tabsReplaced= tabsReplaced.substr(0, i) + "&gt;" +  tabsReplaced.substr(i + 1);
			        }
			    }
			}

			return tabsReplaced;
		}

		function imageParse(origString){
			var openImageReplaced= origString.replace(/<img>/g,"<img width=\"400px\" src=\"")
			var closeImageReplaced = openImageReplaced.replace(/<\/img>/g,"\" />");


			for(var i=0;i<closeImageReplaced.length;i++){
			    if(closeImageReplaced.charAt(i)=='<' && closeImageReplaced.charAt(i+1)!=" "){
			        if(closeImageReplaced.substring(i+1,i+4)!="img" && closeImageReplaced.substring(i+1,i+5)!="/img"){
			            closeImageReplaced=  closeImageReplaced.substr(0, i) + "&lt;" + closeImageReplaced.substr(i + 1);
			        }
			    }
			}

			for(var i=1;i<closeImageReplaced.length;i++){
			    if(closeImageReplaced.charAt(i)=='>' && closeImageReplaced.charAt(i-1)!=" "){
			        if(closeImageReplaced.charAt(i-1) !="/"){
			            closeImageReplaced= closeImageReplaced.substr(0, i) + "&gt;" +  closeImageReplaced.substr(i + 1);
			        }
			    }
			}


			return closeImageReplaced;
		}


	</script> 


</body>
</html>